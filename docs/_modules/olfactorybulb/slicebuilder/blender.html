

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>olfactorybulb.slicebuilder.blender &mdash; Olfactory Bulb 1.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home" alt="Documentation Home"> Olfactory Bulb
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../gettingstarted.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../visualizing.html">Visualizing the Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../recreating.html">Recreating the Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cloud.html">Running Simulations in the Cloud (AWS)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../olfactorybulb.html">Model Python Class Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Olfactory Bulb</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>olfactorybulb.slicebuilder.blender</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for olfactorybulb.slicebuilder.blender</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This is the main class where NEURON cells are imported into Blender, where they are positioned and oriented within</span>
<span class="sd">bulbar layers. Transformed cell coordinates are saved for later instatiation by NEURON during simulations.</span>
<span class="sd">Synapse locations are identified and saved into synapse set files.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">bpy</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">bpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">from</span> <span class="nn">mathutils</span> <span class="kn">import</span> <span class="n">Vector</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">pi</span><span class="p">,</span> <span class="n">acos</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>
<span class="kn">from</span> <span class="nn">olfactorybulb</span> <span class="kn">import</span> <span class="n">slices</span>
<span class="kn">from</span> <span class="nn">blenderneuron.blender.utils</span> <span class="kn">import</span> <span class="n">fast_get</span><span class="p">,</span> <span class="n">make_safe_filename</span>
<span class="kn">from</span> <span class="nn">blenderneuron.blender.views.vectorconfinerview</span> <span class="kn">import</span> <span class="n">VectorConfinerView</span>
<span class="kn">from</span> <span class="nn">blenderneuron.blender.views.synapseformerview</span> <span class="kn">import</span> <span class="n">SynapseFormerView</span>
<span class="kn">import</span> <span class="nn">blenderneuron.blender</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Sources:</span>
<span class="sd">Kikuta et. al. 2013 - TC soma distance from Glom center ~200 um</span>
<span class="sd">Witman and Greer 2007 - GC spine reach - from digitized figure 5.5 um</span>
<span class="sd">&#39;&#39;&#39;</span>

<div class="viewcode-block" id="auto_start"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.auto_start">[docs]</a><span class="k">def</span> <span class="nf">auto_start</span><span class="p">(</span><span class="n">scene</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A Blender startup script that starts the SliceBuilder on Blender startup</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Remove auto-execute command after starting</span>
    <span class="n">bpy</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">scene_update_post</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">auto_start</span><span class="p">)</span>

    <span class="c1"># Assuming starting at repo root</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">())</span>

    <span class="c1"># Create a slice builder class</span>
    <span class="n">sbb</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">SliceBuilder</span> <span class="o">=</span> <span class="n">SliceBuilderBlender</span><span class="p">()</span>

    <span class="c1"># from line_profiler import LineProfiler</span>
    <span class="c1"># lp = LineProfiler()</span>
    <span class="c1"># lp.add_function(sbb.add_mc)</span>
    <span class="c1"># lp.add_function(sbb.add_tc)</span>
    <span class="c1"># lp.add_function(sbb.add_gc)</span>
    <span class="c1"># lp.add_function(sbb.import_instance)</span>
    <span class="c1"># profiled_build = lp(sbb.build)</span>
    <span class="c1"># profiled_build()</span>
    <span class="c1"># lp.print_stats()</span>

    <span class="n">sbb</span><span class="o">.</span><span class="n">build</span><span class="p">()</span></div>



<div class="viewcode-block" id="SliceBuilderBlender"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender">[docs]</a><span class="k">class</span> <span class="nc">SliceBuilderBlender</span><span class="p">:</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the BlenderNEURON node that runs within Blender</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">bpy</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">Object</span><span class="o">.</span><span class="n">BlenderNEURON_node</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">neuron</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the client class that communicates with NEURON via methods defined in `olfactorybulb.slicebuilder.nrn`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">client</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">slice_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the path to the directory where virtual slice cell and synapse files will be saved</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slice_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">slices</span><span class="o">.</span><span class="vm">__file__</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">slice_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_name</span><span class="p">)</span>

<div class="viewcode-block" id="SliceBuilderBlender.__init__"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">odors</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;Apple&#39;</span><span class="p">],</span>
                 <span class="n">slice_object_name</span><span class="o">=</span><span class="s1">&#39;DorsalColumnSlice&#39;</span><span class="p">,</span>
                 <span class="n">max_mcs</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">max_tcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_gcs</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>  <span class="c1"># Uses mouse ratios if None</span>
                 <span class="n">mc_particles_object_name</span><span class="o">=</span><span class="s1">&#39;2 ML Particles&#39;</span><span class="p">,</span>
                 <span class="n">tc_particles_object_name</span><span class="o">=</span><span class="s1">&#39;1 OPL Particles&#39;</span><span class="p">,</span>
                 <span class="n">gc_particles_object_name</span><span class="o">=</span><span class="s1">&#39;4 GRL Particles&#39;</span><span class="p">,</span>
                 <span class="n">glom_particles_object_name</span><span class="o">=</span><span class="s1">&#39;0 GL Particles&#39;</span><span class="p">,</span>
                 <span class="n">glom_layer_object_name</span><span class="o">=</span><span class="s1">&#39;0 GL&#39;</span><span class="p">,</span>
                 <span class="n">outer_opl_object_name</span><span class="o">=</span><span class="s1">&#39;1 OPL-Outer&#39;</span><span class="p">,</span>
                 <span class="n">inner_opl_object_name</span><span class="o">=</span><span class="s1">&#39;1 OPL-Inner&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the slice builder</span>

<span class="sd">        :param odors: A list of odors whose glomeruli to include (e.g. [&#39;Apple&#39;, &#39;Mint&#39;]), use &#39;all&#39; for all gloms.</span>
<span class="sd">        :param slice_object_name: The name of the Blender mesh that defines the shape of the virtual slice</span>
<span class="sd">        :param max_mcs: The maximum number of MCs to include in the model</span>
<span class="sd">        :param max_tcs: Maximum number of TCs. Use None to use mouse MC-TC ratio.</span>
<span class="sd">        :param max_gcs: Maximum number of GCs. Use None to use mouse MC-GC ratio.</span>
<span class="sd">        :param mc_particles_object_name: The name of the Blender object that defines MC soma locations</span>
<span class="sd">        :param tc_particles_object_name: The name of the Blender object that defines TC soma locations</span>
<span class="sd">        :param gc_particles_object_name: The name of the Blender object that defines GC soma locations</span>
<span class="sd">        :param glom_particles_object_name: The name of the Blender object that defines glomerulus locations</span>
<span class="sd">        :param glom_layer_object_name: The name of the Blender object that defines the geometry of glomerular layer</span>
<span class="sd">        :param outer_opl_object_name: The name of the Blender object that defines the outer boundary of the OPL layer</span>
<span class="sd">        :param inner_opl_object_name: The name of the Blender object that defines the inner boundary of the OPL layer</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># In mouse, for each MC, there are:</span>
        <span class="c1"># See: model-data.sql &gt; measurement table &gt; mc/gc/tc_count entries for sources</span>
        <span class="c1">#  2.36 TCs</span>
        <span class="k">if</span> <span class="n">max_tcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_tcs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">max_mcs</span> <span class="o">*</span> <span class="mf">2.36</span><span class="p">))</span>

        <span class="c1">#  16.97 GCs</span>
        <span class="k">if</span> <span class="n">max_gcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_gcs</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">max_mcs</span> <span class="o">*</span> <span class="mf">16.97</span><span class="p">))</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">odors</span> <span class="o">=</span> <span class="n">odors</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glom_cells</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">slice_name</span> <span class="o">=</span> <span class="n">slice_object_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_mcs</span> <span class="o">=</span> <span class="n">max_mcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_tcs</span> <span class="o">=</span> <span class="n">max_tcs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_gcs</span> <span class="o">=</span> <span class="n">max_gcs</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">glom_particles_name</span> <span class="o">=</span> <span class="n">glom_particles_object_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tc_particles_name</span> <span class="o">=</span> <span class="n">tc_particles_object_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_particles_name</span> <span class="o">=</span> <span class="n">mc_particles_object_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_particles_name</span> <span class="o">=</span> <span class="n">gc_particles_object_name</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">glom_layer_object_name</span> <span class="o">=</span> <span class="n">glom_layer_object_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outer_opl_object_name</span> <span class="o">=</span> <span class="n">outer_opl_object_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inner_opl_object_name</span> <span class="o">=</span> <span class="n">inner_opl_object_name</span>

        <span class="c1"># Within slice</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_locations</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_cell_base_model_info</span><span class="p">()</span>

        <span class="c1"># Show as section objects</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_groups</span><span class="p">()</span>

        <span class="c1"># Clear slice files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_slice_files</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.build"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.build">[docs]</a>    <span class="k">def</span> <span class="nf">build</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Positions MC/TC/GC models within the OB layers, identifies synapse locations, and saves the model</span>
<span class="sd">        for later simulation in NEURON</span>

<span class="sd">        :param seed: The random seed to use (to assist reproducibility)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_alignment_angle</span> <span class="o">=</span> <span class="mi">35</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_locs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding MC </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_mc</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_locs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding TC </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_tc</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_locs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding GC </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_gc</span><span class="p">(</span><span class="n">loc</span><span class="p">)</span>

        <span class="c1"># Add synapse sets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_synapse_sets</span><span class="p">()</span>

        <span class="c1"># Select all cells in groups</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;MCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select_roots</span><span class="p">(</span><span class="s1">&#39;All&#39;</span><span class="p">,</span><span class="s1">&#39;mc*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;TCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select_roots</span><span class="p">(</span><span class="s1">&#39;All&#39;</span><span class="p">,</span><span class="s1">&#39;tc*&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;GCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">select_roots</span><span class="p">(</span><span class="s1">&#39;All&#39;</span><span class="p">,</span><span class="s1">&#39;gc*&#39;</span><span class="p">)</span>

        <span class="n">gcs_with_syns</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c1"># Find and save syns in all synapse sets</span>
        <span class="k">for</span> <span class="n">syn_set</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">synapse_sets</span><span class="p">:</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_dir</span><span class="p">,</span> <span class="n">make_safe_filename</span><span class="p">(</span><span class="n">syn_set</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving synapse set &quot;&#39;</span><span class="o">+</span><span class="n">syn_set</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;&quot; saved to: &#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>

            <span class="n">pairs</span> <span class="o">=</span> <span class="n">syn_set</span><span class="o">.</span><span class="n">get_synapse_locations</span><span class="p">()</span>

            <span class="c1"># Note which GCs have synapses</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">pairs</span><span class="p">:</span>
                <span class="n">source_cell</span> <span class="o">=</span> <span class="n">pair</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">section_name</span><span class="p">[:</span><span class="n">pair</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">section_name</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;]&#39;</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">gcs_with_syns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">source_cell</span><span class="p">)</span>

            <span class="n">syn_set</span><span class="o">.</span><span class="n">save_synapses</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># Remove unconnected GCs</span>
        <span class="c1"># they won&#39;t contribute to simulation output</span>
        <span class="c1"># removing them makes the simulation smaller</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;GCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">include_roots_by_name</span><span class="p">(</span>
            <span class="p">[</span><span class="n">cell</span> <span class="o">+</span> <span class="s1">&#39;.soma&#39;</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">gcs_with_syns</span><span class="p">],</span>
            <span class="n">exclude_others</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>

        <span class="c1"># Save all cells</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_dir</span><span class="p">,</span> <span class="n">make_safe_filename</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.json&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving cell group </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> to: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">group</span><span class="o">.</span><span class="n">roots</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span> <span class="n">group</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
            <span class="n">group</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

        <span class="c1"># Save glom-cell associations</span>
        <span class="n">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_dir</span><span class="p">,</span> <span class="s1">&#39;glom_cells.json&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saving glomerulus-cells links to: &#39;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
            <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glom_cells</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

        <span class="c1"># Initially, reduce group display detail levels - All can be changed in Blender GUI</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;MCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interaction_granularity</span> <span class="o">=</span> <span class="s1">&#39;Cell&#39;</span> <span class="c1"># Clicking any cell dendrite will select the whole cell</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;TCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interaction_granularity</span> <span class="o">=</span> <span class="s1">&#39;Cell&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;GCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">interaction_granularity</span> <span class="o">=</span> <span class="s1">&#39;Cell&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;MCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_lines</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># Dendrites will be shown as 0-width lines</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;TCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_lines</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;GCs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">as_lines</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Show all group cells</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Creating blender scene...&#39;</span><span class="p">)</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">blenderneuron</span><span class="o">.</span><span class="n">display_groups</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;DONE&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.add_synapse_sets"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.add_synapse_sets">[docs]</a>    <span class="k">def</span> <span class="nf">add_synapse_sets</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates synapse sets between MCs-GCs and TCs-GCs</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Delete the default set</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">synapse_sets</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">create_synapse_set</span><span class="p">(</span><span class="s1">&#39;GCs&#39;</span><span class="p">,</span> <span class="s1">&#39;MCs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_synapse_set</span><span class="p">(</span><span class="s1">&#39;GCs&#39;</span><span class="p">,</span> <span class="s1">&#39;TCs&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.create_synapse_set"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.create_synapse_set">[docs]</a>    <span class="k">def</span> <span class="nf">create_synapse_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_from</span><span class="p">,</span> <span class="n">group_to</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Defines a synapse set between two BlenderNEURON groups of cells</span>

<span class="sd">        :param group_from: One of &#39;MCs&#39;, &#39;TCs&#39;, &#39;GCs&#39;</span>
<span class="sd">        :param group_to: One of &#39;MCs&#39;, &#39;TCs&#39;, &#39;GCs&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">new_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">add_synapse_set</span><span class="p">(</span><span class="n">group_from</span> <span class="o">+</span> <span class="s1">&#39;-&gt;&#39;</span> <span class="o">+</span> <span class="n">group_to</span><span class="p">)</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">group_source</span> <span class="o">=</span> <span class="n">group_from</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">group_dest</span> <span class="o">=</span> <span class="n">group_to</span>

        <span class="n">new_set</span><span class="o">.</span><span class="n">max_distance</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">use_radius</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">max_syns_per_pt</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">section_pattern_source</span> <span class="o">=</span> <span class="s2">&quot;*apic*&quot;</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">section_pattern_dest</span> <span class="o">=</span> <span class="s2">&quot;*dend*&quot;</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">synapse_name_dest</span> <span class="o">=</span> <span class="s1">&#39;GabaSyn&#39;</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">synapse_params_dest</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span>
            <span class="s1">&#39;gmax&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>  <span class="c1"># uS,</span>
            <span class="s1">&#39;tau1&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>  <span class="c1"># ms</span>
            <span class="s1">&#39;tau2&#39;</span><span class="p">:</span> <span class="mi">100</span>  <span class="c1"># ms</span>
        <span class="p">})</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">is_reciprocal</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">synapse_name_source</span> <span class="o">=</span> <span class="s1">&#39;AmpaNmdaSyn&#39;</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">synapse_params_source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">({</span><span class="s1">&#39;gmax&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">})</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">create_spines</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">spine_neck_diameter</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">spine_head_diameter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">spine_name_prefix</span> <span class="o">=</span> <span class="s1">&#39;Spine&#39;</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">conduction_velocity</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">initial_weight</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">new_set</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="mi">0</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.clear_slice_files"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.clear_slice_files">[docs]</a>    <span class="k">def</span> <span class="nf">clear_slice_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Deletes previously saved virtual slice .json files from the slice directory</span>
<span class="sd">        (e.g. olfactorybulb/slices/DorsalColumnSlice/.json)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_dir</span>

        <span class="c1"># Match e.g. &#39;MCs.json&#39;</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">&#39;.+json&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">file</span><span class="p">)))</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.get_cell_locations"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.get_cell_locations">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_locations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Identifies the locations of glomeruli, mcs, tcs, and gcs that are contained by the virtual slice.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">globalize_slice</span><span class="p">()</span>

        <span class="n">odor_glom_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron</span><span class="o">.</span><span class="n">get_odor_gloms</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">odors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glom_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locs_within_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glom_particles_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_name</span><span class="p">,</span> <span class="n">odor_glom_ids</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inner_opl_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_opl_locs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_opl_object_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outer_opl_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_opl_locs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_opl_object_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mc_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locs_within_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_particles_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_name</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_mcs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tc_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locs_within_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_particles_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_name</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_tcs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_locs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_locs_within_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_particles_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_name</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_gcs</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Gloms:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glom_locs</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;TCs:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_locs</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;MCs:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_locs</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;GCs:&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_locs</span><span class="p">))</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.get_opl_locs"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.get_opl_locs">[docs]</a>    <span class="k">def</span> <span class="nf">get_opl_locs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">opl_name</span><span class="p">,</span> <span class="n">slice_obj_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the coordinates of inner or outer boundaries of the OPL layer that are contained by the virtual slice</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="n">opl_name</span><span class="p">]</span>
        <span class="n">wm</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">matrix_world</span>

        <span class="n">locs</span> <span class="o">=</span> <span class="n">fast_get</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">vertices</span><span class="p">,</span> <span class="s1">&#39;co&#39;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">globalize</span><span class="p">(</span><span class="n">loc</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">wm</span> <span class="o">*</span> <span class="n">Vector</span><span class="p">(</span><span class="n">loc</span><span class="p">))</span>

        <span class="c1"># Globalize the coordinates</span>
        <span class="n">locs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">globalize</span><span class="p">,</span> <span class="n">locs</span><span class="p">)))</span>

        <span class="n">slice_obj</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="n">slice_obj_name</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">pt</span>
                         <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">locs</span>
                         <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="n">Vector</span><span class="p">(</span><span class="n">pt</span><span class="p">),</span> <span class="n">slice_obj</span><span class="p">)])</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.get_cell_base_model_info"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.get_cell_base_model_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_cell_base_model_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets metadata info about each of the base (untransformed) MC, TC, and GC cell models</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mc_base_models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tc_base_models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">gc_base_models</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">neuron</span><span class="o">.</span><span class="n">get_base_model_info</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mc_base_models</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_base_models</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tc_base_models</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_base_models</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_base_models</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_base_models</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="n">i</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_apic_mc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_longest_apic_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_base_models</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mc_apic_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_apic_lengths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_base_models</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_apic_tc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_longest_apic_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_base_models</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tc_apic_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_apic_lengths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_base_models</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_apic_gc_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_longest_apic_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_base_models</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gc_apic_lengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_apic_lengths</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_base_models</span><span class="p">)</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.get_apic_lengths"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.get_apic_lengths">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_apic_lengths</span><span class="p">(</span><span class="n">base_models</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the apical dendrite lengths of the specified base models</span>

<span class="sd">        :param base_models: List with metadata of base cell models</span>
<span class="sd">        :return: A numpy array of apical dendrite lengths</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">c</span><span class="p">[</span><span class="s2">&quot;apical_dendrite_reach&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">base_models</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.create_groups"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.create_groups">[docs]</a>    <span class="k">def</span> <span class="nf">create_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates empty BlenderNEURON cell groups for MCs, TCs, and GCs.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Remove the default group</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="s1">&#39;Group.000&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>

        <span class="c1"># Create empty cell groups</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">add_group</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;MCs&#39;</span><span class="p">,</span> <span class="s1">&#39;TCs&#39;</span><span class="p">,</span> <span class="s1">&#39;GCs&#39;</span><span class="p">]]</span>

        <span class="c1"># show each section as blender objects - necessary for dend alignment</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
            <span class="n">group</span><span class="o">.</span><span class="n">interaction_granularity</span> <span class="o">=</span> <span class="s1">&#39;Section&#39;</span>
            <span class="n">group</span><span class="o">.</span><span class="n">recording_granularity</span> <span class="o">=</span> <span class="s1">&#39;Cell&#39;</span>
            <span class="n">group</span><span class="o">.</span><span class="n">record_activity</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Add some color</span>
        <span class="n">groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">default_color</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.71</span><span class="p">,</span> <span class="mf">0.96</span><span class="p">]</span>       <span class="c1"># MCs - neon blue</span>
        <span class="n">groups</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">default_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span>    <span class="mf">0.73</span><span class="p">,</span> <span class="mf">0.82</span><span class="p">]</span>       <span class="c1"># TCs - pink</span>
        <span class="n">groups</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">default_color</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span>    <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.11</span><span class="p">]</span>       <span class="c1"># GCs - gold</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.globalize_slice"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.globalize_slice">[docs]</a>    <span class="k">def</span> <span class="nf">globalize_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts all points of the slice object to global coordinates (relative to scene origin)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Apply all/any transformations to the slice</span>
        <span class="nb">slice</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_name</span><span class="p">]</span>
        <span class="nb">slice</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">active</span> <span class="o">=</span> <span class="nb">slice</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">transform_apply</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="nb">slice</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.add_mc"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.add_mc">[docs]</a>    <span class="k">def</span> <span class="nf">add_mc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mc_pt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiates in NEURON, places, and orients a mitral cell within the mitral cell layer</span>
<span class="sd">        and confines its lateral dendrites to the curvature of the surrounding internal part</span>
<span class="sd">        of the outer plexiform layer.</span>

<span class="sd">        :param mc_pt: A dict whose &#39;loc&#39; key contains a numpy array of xyz coordinates of the cell soma</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># find the closest glom layer loc - cell will be pointed towards it</span>
        <span class="n">closest_glom_loc</span><span class="p">,</span> <span class="n">dist_to_gl</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">closest_point_on_object</span><span class="p">(</span><span class="n">mc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">glom_layer_object_name</span><span class="p">])</span>

        <span class="n">longest_apic_reach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_apic_mc_info</span><span class="p">[</span><span class="s2">&quot;apical_dendrite_reach&quot;</span><span class="p">]</span>

        <span class="c1"># Apics are too short use longest apic MC</span>
        <span class="k">if</span> <span class="n">dist_to_gl</span> <span class="o">&gt;</span> <span class="n">longest_apic_reach</span><span class="p">:</span>
            <span class="n">mc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_apic_mc_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># get mcs with apics longer than dist to GL</span>
            <span class="n">longer_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_apic_lengths</span> <span class="o">&gt;</span> <span class="n">dist_to_gl</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># pick a random mc from this list</span>
            <span class="n">mc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_base_models</span><span class="p">,</span> <span class="n">longer_idxs</span><span class="p">)</span>

        <span class="c1"># find a glom whose distance is as close to the length of the mc apic</span>
        <span class="n">matching_glom_loc</span><span class="p">,</span> <span class="n">matching_glom_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_matching_glom</span><span class="p">(</span><span class="n">mc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">mc</span><span class="p">)</span>

        <span class="n">base_class</span> <span class="o">=</span> <span class="n">mc</span><span class="p">[</span><span class="s2">&quot;class_name&quot;</span><span class="p">]</span>
        <span class="n">apic_glom_loc</span> <span class="o">=</span> <span class="n">matching_glom_loc</span>

        <span class="c1"># Create the selected MC in NRN</span>
        <span class="n">instance_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron</span><span class="o">.</span><span class="n">create_cell</span><span class="p">(</span><span class="s1">&#39;MC&#39;</span><span class="p">,</span> <span class="n">base_class</span><span class="p">)</span>

        <span class="c1"># Associate the cell with the glomerulus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_cell_to_glom</span><span class="p">(</span><span class="n">instance_name</span><span class="p">,</span> <span class="n">matching_glom_id</span><span class="p">)</span>

        <span class="c1"># Import cell into Blender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_instance</span><span class="p">(</span><span class="n">instance_name</span><span class="p">,</span> <span class="s1">&#39;MCs&#39;</span><span class="p">)</span>

        <span class="n">mc_soma</span><span class="p">,</span> <span class="n">mc_apic_start</span><span class="p">,</span> <span class="n">mc_apic_end</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_key_mctc_section_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mc_base_models</span><span class="p">,</span> <span class="n">base_class</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">)</span>

        <span class="c1"># Align apical towards the closest glom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_orient_align_mctc</span><span class="p">(</span><span class="n">mc_soma</span><span class="p">,</span>
                                        <span class="n">mc_apic_start</span><span class="p">,</span>
                                        <span class="n">mc_apic_end</span><span class="p">,</span>
                                        <span class="n">mc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span>
                                        <span class="n">closest_glom_loc</span><span class="p">,</span>
                                        <span class="n">apic_glom_loc</span><span class="p">)</span>

        <span class="c1"># Retain the reoriented cell</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">blenderneuron</span><span class="o">.</span><span class="n">update_groups_with_view_data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">confine_dends</span><span class="p">(</span>
            <span class="s1">&#39;MCs&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inner_opl_object_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outer_opl_object_name</span><span class="p">,</span>
            <span class="n">max_angle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_alignment_angle</span><span class="p">,</span>
            <span class="n">height_start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
            <span class="n">height_end</span><span class="o">=</span><span class="mf">0.6</span>
        <span class="p">)</span>

        <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">blenderneuron</span><span class="o">.</span><span class="n">update_groups_with_view_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.link_cell_to_glom"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.link_cell_to_glom">[docs]</a>    <span class="k">def</span> <span class="nf">link_cell_to_glom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">,</span> <span class="n">matching_glom_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds a cell instance to a list of cells that belong to the specified glomerulus</span>

<span class="sd">        :param instance_name: The name of the cell as returned by NEURON</span>
<span class="sd">        :param matching_glom_id: The id of the glomerulus, with which to associate the cell</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">glom_cells</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glom_cells</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">matching_glom_id</span><span class="p">,</span> <span class="p">[])</span>

        <span class="n">glom_cells</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.soma&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">glom_cells</span><span class="p">[</span><span class="n">matching_glom_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">glom_cells</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.import_instance"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.import_instance">[docs]</a>    <span class="k">def</span> <span class="nf">import_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">,</span> <span class="n">group_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Imports and shows a cell instantiated in NEURON into Blender using a BlenderNEURON group</span>

<span class="sd">        :param instance_name: The name of the cell model to import (as named by NEURON)</span>
<span class="sd">        :param group_name: The name of the group to associate the cell with</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get updated list of NRN cells in Blender</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">blenderneuron</span><span class="o">.</span><span class="n">get_cell_list_from_neuron</span><span class="p">()</span>

        <span class="c1"># Select the created instance</span>
        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span>
        <span class="n">group</span><span class="o">.</span><span class="n">include_roots_by_name</span><span class="p">([</span><span class="n">instance_name</span><span class="p">],</span> <span class="n">exclude_others</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Import group with the created cell and show it</span>
        <span class="n">group</span><span class="o">.</span><span class="n">import_group</span><span class="p">()</span>
        <span class="n">group</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.add_tc"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.add_tc">[docs]</a>    <span class="k">def</span> <span class="nf">add_tc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tc_pt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Similar to `add_mc(pt)`. Instantiates, places, and orients a tufted cell model and</span>
<span class="sd">        confines its lateral dendrites to the outer portion of the outer plexiform layer.</span>

<span class="sd">        :param tc_pt: A dict with &#39;loc&#39; that contains a numpy array of xyz coordinates of the TC soma</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># find the closest glom layer loc - cell will be pointed towards it</span>
        <span class="n">closest_glom_loc</span><span class="p">,</span> <span class="n">dist_to_gl</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">closest_point_on_object</span><span class="p">(</span><span class="n">tc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">glom_layer_object_name</span><span class="p">])</span>

        <span class="n">longest_apic_reach</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_apic_tc_info</span><span class="p">[</span><span class="s2">&quot;apical_dendrite_reach&quot;</span><span class="p">]</span>

        <span class="c1"># Apics are too short use longest apic TC</span>
        <span class="k">if</span> <span class="n">dist_to_gl</span> <span class="o">&gt;</span> <span class="n">longest_apic_reach</span><span class="p">:</span>
            <span class="n">tc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_apic_tc_info</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Apics are longer than distance</span>
            <span class="c1"># get tcs with apics longer than the closest glom,</span>
            <span class="c1"># but no further than ~200 um from glom (Source: Kikuta et. al. 2013)</span>
            <span class="n">longer_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_apic_lengths</span> <span class="o">&gt;</span> <span class="n">dist_to_gl</span><span class="p">)</span> <span class="o">&amp;</span>
                                   <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_apic_lengths</span> <span class="o">-</span> <span class="n">dist_to_gl</span> <span class="o">&lt;</span> <span class="mi">200</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># pick a random tc from this list</span>
            <span class="n">tc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_base_models</span><span class="p">,</span> <span class="n">longer_idxs</span><span class="p">)</span>

        <span class="c1"># find a glom whose distance is as close to the length of the tc apic</span>
        <span class="n">matching_glom_loc</span><span class="p">,</span> <span class="n">matching_glom_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_matching_glom</span><span class="p">(</span><span class="n">tc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">tc</span><span class="p">)</span>

        <span class="n">base_class</span> <span class="o">=</span> <span class="n">tc</span><span class="p">[</span><span class="s2">&quot;class_name&quot;</span><span class="p">]</span>
        <span class="n">apic_glom_loc</span> <span class="o">=</span> <span class="n">matching_glom_loc</span>

        <span class="c1"># Create the selected TC in NRN</span>
        <span class="n">instance_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron</span><span class="o">.</span><span class="n">create_cell</span><span class="p">(</span><span class="s1">&#39;TC&#39;</span><span class="p">,</span> <span class="n">base_class</span><span class="p">)</span>

        <span class="c1"># Associate the cell with the glomerulus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_cell_to_glom</span><span class="p">(</span><span class="n">instance_name</span><span class="p">,</span> <span class="n">matching_glom_id</span><span class="p">)</span>

        <span class="c1"># Import it into Blender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_instance</span><span class="p">(</span><span class="n">instance_name</span><span class="p">,</span> <span class="s1">&#39;TCs&#39;</span><span class="p">)</span>

        <span class="n">soma</span><span class="p">,</span> <span class="n">apic_start</span><span class="p">,</span> <span class="n">apic_end</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_key_mctc_section_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tc_base_models</span><span class="p">,</span> <span class="n">base_class</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">)</span>

        <span class="c1"># Align apical towards the closest glom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_orient_align_mctc</span><span class="p">(</span><span class="n">soma</span><span class="p">,</span>
                                        <span class="n">apic_start</span><span class="p">,</span>
                                        <span class="n">apic_end</span><span class="p">,</span>
                                        <span class="n">tc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span>
                                        <span class="n">closest_glom_loc</span><span class="p">,</span>
                                        <span class="n">apic_glom_loc</span><span class="p">)</span>

        <span class="c1"># Retain the reoriented cell</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">blenderneuron</span><span class="o">.</span><span class="n">update_groups_with_view_data</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">confine_dends</span><span class="p">(</span>
            <span class="s1">&#39;TCs&#39;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inner_opl_object_name</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outer_opl_object_name</span><span class="p">,</span>
            <span class="n">max_angle</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">max_alignment_angle</span><span class="p">,</span>
            <span class="n">height_start</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span>
            <span class="n">height_end</span><span class="o">=</span><span class="mf">1.0</span>
        <span class="p">)</span>

        <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">blenderneuron</span><span class="o">.</span><span class="n">update_groups_with_view_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.find_closest_glom"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.find_closest_glom">[docs]</a>    <span class="k">def</span> <span class="nf">find_closest_glom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds the closest glomerulus to the specified coordinates</span>

<span class="sd">        :param cell_loc: A numpy array of xyz coordinates</span>
<span class="sd">        :return: A tuple with the location of the closest glomerulus and distance to it</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get distances to individual gloms</span>
        <span class="n">glom_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_to_gloms</span><span class="p">(</span><span class="n">cell_loc</span><span class="p">)</span>

        <span class="n">matching_glom_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">glom_dists</span><span class="p">)</span>
        <span class="n">matching_glom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glom_locs</span><span class="p">[</span><span class="n">matching_glom_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">matching_glom</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">glom_dists</span><span class="p">[</span><span class="n">matching_glom_idx</span><span class="p">]</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.find_matching_glom"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.find_matching_glom">[docs]</a>    <span class="k">def</span> <span class="nf">find_matching_glom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_loc</span><span class="p">,</span> <span class="n">cell_model_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Finds a glomerulus that is approximately the same distance from the soma</span>
<span class="sd">        as the length of the cells apical dendrite</span>

<span class="sd">        :param cell_loc: A numpy xyz array with coordinates</span>
<span class="sd">        :param cell_model_info: Cell model metadata dict with &#39;apical_dendrite_reach&#39; key that contains the apical dendrite length</span>
<span class="sd">        :return: The xyz location and the id of the matching glomerulus</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Get distances to individual gloms</span>
        <span class="n">glom_dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_to_gloms</span><span class="p">(</span><span class="n">cell_loc</span><span class="p">)</span>

        <span class="n">matching_glom_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">glom_dists</span> <span class="o">-</span> <span class="n">cell_model_info</span><span class="p">[</span><span class="s2">&quot;apical_dendrite_reach&quot;</span><span class="p">]))</span>
        <span class="n">matching_glom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">glom_locs</span><span class="p">[</span><span class="n">matching_glom_idx</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">matching_glom</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">matching_glom</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.get_opl_distance_info"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.get_opl_distance_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_opl_distance_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_loc</span><span class="p">,</span> <span class="n">pts</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes distances to and the closest point of an outer plexiform layer to a given point</span>

<span class="sd">        :param cell_loc: The xyz location of a point</span>
<span class="sd">        :param pts: The list of xyz coordinates of the OPL layer mesh</span>
<span class="sd">        :return: A tuple with closest location on the layer, the distance to that point, and a list of distances to all OPL points</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_to</span><span class="p">(</span><span class="n">pts</span><span class="p">,</span> <span class="n">cell_loc</span><span class="p">)</span>
        <span class="n">closest_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">dists</span><span class="p">)</span>

        <span class="n">closest_loc</span> <span class="o">=</span> <span class="n">pts</span><span class="p">[</span><span class="n">closest_idxs</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">closest_dist</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="n">closest_idxs</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">closest_loc</span><span class="p">,</span> <span class="n">closest_dist</span><span class="p">,</span> <span class="n">dists</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.closest_point_on_object"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.closest_point_on_object">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">closest_point_on_object</span><span class="p">(</span><span class="n">global_pt</span><span class="p">,</span> <span class="n">mesh_obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the closest point and distance of a mesh object from a specified point</span>

<span class="sd">        :param global_pt: The point from which to measure distance</span>
<span class="sd">        :param mesh_obj: A mesh object</span>
<span class="sd">        :return: A tuple with an xyz numpy array of the closest point and distance to it</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">local_pt</span> <span class="o">=</span> <span class="n">mesh_obj</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span> <span class="o">*</span> <span class="n">Vector</span><span class="p">(</span><span class="n">global_pt</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">mesh_pt</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mesh_obj</span><span class="o">.</span><span class="n">closest_point_on_mesh</span><span class="p">(</span><span class="n">local_pt</span><span class="p">)</span>

        <span class="n">mesh_pt_global</span> <span class="o">=</span> <span class="n">mesh_obj</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">*</span> <span class="n">mesh_pt</span>

        <span class="n">dist</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">global_pt</span> <span class="o">-</span> <span class="n">mesh_pt_global</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">mesh_pt_global</span><span class="p">),</span> <span class="n">dist</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.add_gc"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.add_gc">[docs]</a>    <span class="k">def</span> <span class="nf">add_gc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gc_pt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Instantiates, places, and orients a granule cell in the granule cell layer</span>

<span class="sd">        :param gc_pt: XYZ array of GC soma location</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># find the closest glom layer loc - cell will be pointed towards it</span>
        <span class="n">glom_loc</span><span class="p">,</span> <span class="n">glom_dist</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">closest_point_on_object</span><span class="p">(</span><span class="n">gc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">glom_layer_object_name</span><span class="p">])</span>
        <span class="c1"># glom_loc, glom_dist = self.find_closest_glom(gc_pt[&#39;loc&#39;])</span>

        <span class="c1"># find the closest inner opl loc - apics must go beyond this</span>
        <span class="n">closest_iopl_loc</span><span class="p">,</span> <span class="n">dist_to_iopl</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">closest_point_on_object</span><span class="p">(</span><span class="n">gc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inner_opl_object_name</span><span class="p">])</span>

        <span class="c1"># find the closest outer opl loc - apics must stay under this</span>
        <span class="n">closest_oopl_loc</span><span class="p">,</span> <span class="n">dist_to_oopl</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">closest_point_on_object</span><span class="p">(</span><span class="n">gc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">outer_opl_object_name</span><span class="p">])</span>

        <span class="c1"># Find such GC models whose apics are confined to the OPL</span>
        <span class="c1"># Specifically:</span>
        <span class="c1"># Get gcs with apics longer than the closest opl</span>
        <span class="c1"># AND</span>
        <span class="c1"># the apic does not exceed outer opl (an external margin is allowed)</span>
        <span class="n">min_length</span> <span class="o">=</span> <span class="n">dist_to_iopl</span>
        <span class="n">max_length</span> <span class="o">=</span> <span class="n">dist_to_oopl</span> <span class="o">+</span> <span class="mi">30</span>

        <span class="n">matching_idxs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_apic_lengths</span> <span class="o">&gt;</span> <span class="n">min_length</span><span class="p">)</span> <span class="o">&amp;</span>
                                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_apic_lengths</span> <span class="o">&lt;</span> <span class="n">max_length</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># If no cell can be confined to OPL, leave that location blank</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching_idxs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># pick a random gc from this list</span>
        <span class="n">gc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_random_model</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_base_models</span><span class="p">,</span> <span class="n">matching_idxs</span><span class="p">)</span>

        <span class="n">base_class</span> <span class="o">=</span> <span class="n">gc</span><span class="p">[</span><span class="s2">&quot;class_name&quot;</span><span class="p">]</span>
        <span class="n">apic_target_loc</span> <span class="o">=</span> <span class="n">glom_loc</span>

        <span class="c1"># Create the selected GC in NRN</span>
        <span class="n">instance_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">neuron</span><span class="o">.</span><span class="n">create_cell</span><span class="p">(</span><span class="s1">&#39;GC&#39;</span><span class="p">,</span> <span class="n">base_class</span><span class="p">)</span>

        <span class="c1"># Import it into Blender</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">import_instance</span><span class="p">(</span><span class="n">instance_name</span><span class="p">,</span> <span class="s1">&#39;GCs&#39;</span><span class="p">)</span>

        <span class="n">soma</span><span class="p">,</span> <span class="n">apic_start</span><span class="p">,</span> <span class="n">apic_end</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">get_key_mctc_section_objects</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gc_base_models</span><span class="p">,</span> <span class="n">base_class</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">position_orient_cell</span><span class="p">(</span><span class="n">soma</span><span class="p">,</span> <span class="n">apic_end</span><span class="p">,</span> <span class="n">gc_pt</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">],</span> <span class="n">apic_target_loc</span><span class="p">)</span>

        <span class="c1"># Retain the reoriented cell</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">ops</span><span class="o">.</span><span class="n">blenderneuron</span><span class="o">.</span><span class="n">update_groups_with_view_data</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.get_random_model"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.get_random_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_random_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_models</span><span class="p">,</span> <span class="n">longer_idxs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given a list of indices stored in longer_idxs, selects a random element of base_models</span>

<span class="sd">        :param base_models: A list of base cell models</span>
<span class="sd">        :param longer_idxs: A list of indices from which to pick a random index</span>
<span class="sd">        :return: A random cell model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">rand_idx</span> <span class="o">=</span> <span class="n">longer_idxs</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">longer_idxs</span><span class="p">))]</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">base_models</span><span class="o">.</span><span class="n">values</span><span class="p">())[</span><span class="n">rand_idx</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">cell</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.confine_dends"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.confine_dends">[docs]</a>    <span class="k">def</span> <span class="nf">confine_dends</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">start_layer_name</span><span class="p">,</span> <span class="n">end_layer_name</span><span class="p">,</span> <span class="n">max_angle</span><span class="p">,</span> <span class="n">height_start</span><span class="p">,</span> <span class="n">height_end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Confines the lateral dendrits of cells in a group to follow the curvature between two layers</span>

<span class="sd">         Height_start and height_end specify fractions that define the corridor between the layers to which</span>
<span class="sd">         the dendrites should be confined. E.g. To confine the dendrites in the halfway between the two layers,</span>
<span class="sd">         closer to the start layer, set height_start and height_end to 0 and 0.5. Set them to 0.5 and 1.0 to confine</span>
<span class="sd">         to the halfway that is closer to the end region. 1.0 corresponds to the local distance between the two layers.</span>

<span class="sd">         The two layers should be &#39;locally&#39; parallel. E.g. two planes, or two concentric spheres. In OB model case,</span>
<span class="sd">         the OB layers are complex shapes, but concentric-like.</span>

<span class="sd">        :param group_name: The name of the group of cells to confine</span>
<span class="sd">        :param start_layer_name: The name of the first confinement layer</span>
<span class="sd">        :param end_layer_name: The name of the second confinement layer</span>
<span class="sd">        :param max_angle: The maximum angle that a dendritic branch can rotate to be confined between layers</span>
<span class="sd">        :param height_start: Fraction between 0-1</span>
<span class="sd">        :param height_end: Fraction between 0-1</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span>

        <span class="c1"># Set the layers</span>
        <span class="n">group</span><span class="o">.</span><span class="n">set_confiner_layers</span><span class="p">(</span><span class="n">start_layer_name</span><span class="p">,</span> <span class="n">end_layer_name</span><span class="p">,</span> <span class="n">max_angle</span><span class="p">,</span> <span class="n">height_start</span><span class="p">,</span> <span class="n">height_end</span><span class="p">)</span>
        <span class="n">group</span><span class="o">.</span><span class="n">setup_confiner</span><span class="p">()</span>
        <span class="n">group</span><span class="o">.</span><span class="n">confine_between_layers</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.save_transform"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.save_transform">[docs]</a>    <span class="k">def</span> <span class="nf">save_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Saves trnsformed cells in a cell group to a NEURON compatible file</span>

<span class="sd">        :param group_name: The name of the BlenderNEURON cell group to save</span>
<span class="sd">        :param instance_name: The name of the file to save. Can be the name of the cell soma segment.</span>
<span class="sd">        &quot;&quot;&quot;</span>


        <span class="n">group</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node</span><span class="o">.</span><span class="n">groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span>

        <span class="c1"># Make instance name a valid python module name (eg: MC1[0].soma -&gt; MC1_0.py)</span>
        <span class="n">file_name</span> <span class="o">=</span> <span class="n">instance_name</span> \
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;].soma&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> \
                        <span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;[&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="s2">&quot;.py&quot;</span>

        <span class="c1"># Save to slice folder</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

        <span class="c1"># Save cells part of the group as files</span>
        <span class="n">group</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.get_key_mctc_section_objects"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.get_key_mctc_section_objects">[docs]</a>    <span class="k">def</span> <span class="nf">get_key_mctc_section_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model_dict</span><span class="p">,</span> <span class="n">base_class</span><span class="p">,</span> <span class="n">instance_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets the blender objects of soma, apical dendrite start (base), and apical dendrite end (tuft) sections</span>

<span class="sd">        :param base_model_dict: A dicttionary of base cell model metadata info</span>
<span class="sd">        :param base_class: The name of a base cell class</span>
<span class="sd">        :param instance_name: The name of blender object of cell soma section</span>
<span class="sd">        :return: Blender objects of soma, apical dendrite start, and apical dendrite end</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cell_info</span> <span class="o">=</span> <span class="n">base_model_dict</span><span class="p">[</span><span class="n">base_class</span><span class="p">]</span>
        <span class="n">apic_pattern</span> <span class="o">=</span> <span class="n">instance_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.soma&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;.apic[</span><span class="si">%s</span><span class="s1">]&#39;</span>

        <span class="n">bpy_objects</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span>
        <span class="n">soma</span> <span class="o">=</span> <span class="n">bpy_objects</span><span class="p">[</span><span class="n">instance_name</span><span class="p">]</span>

        <span class="n">apic_start</span> <span class="o">=</span> <span class="n">bpy_objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">apic_pattern</span> <span class="o">%</span> <span class="n">cell_info</span><span class="p">[</span><span class="s2">&quot;apical_dendrite_start&quot;</span><span class="p">])</span>
        <span class="n">apic_end</span> <span class="o">=</span> <span class="n">bpy_objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">apic_pattern</span> <span class="o">%</span> <span class="n">cell_info</span><span class="p">[</span><span class="s2">&quot;apical_dendrite_end&quot;</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">soma</span><span class="p">,</span> <span class="n">apic_start</span><span class="p">,</span> <span class="n">apic_end</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.get_longest_apic_model"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.get_longest_apic_model">[docs]</a>    <span class="k">def</span> <span class="nf">get_longest_apic_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_model_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the metadata of the base cell model that has that longest apical dendrite</span>

<span class="sd">        :param base_model_dict: The dict of base cell model metadatas</span>
<span class="sd">        :return: A metadata object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cell_names</span><span class="p">,</span> <span class="n">apic_lengths</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">cell</span><span class="p">[</span><span class="s2">&quot;class_name&quot;</span><span class="p">],</span> <span class="n">cell</span><span class="p">[</span><span class="s2">&quot;apical_dendrite_reach&quot;</span><span class="p">])</span>
                                         <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">base_model_dict</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>

        <span class="n">max_apic_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">apic_lengths</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">base_model_dict</span><span class="p">[</span><span class="n">cell_names</span><span class="p">[</span><span class="n">max_apic_idx</span><span class="p">]]</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.dist_to_gloms"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.dist_to_gloms">[docs]</a>    <span class="k">def</span> <span class="nf">dist_to_gloms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an array of distances to glomeruli from a given location</span>

<span class="sd">        :param loc: XYZ coordinate</span>
<span class="sd">        :return: Distances to glomeruli</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dist_to</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">glom</span><span class="p">[</span><span class="s1">&#39;loc&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">glom</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">glom_locs</span><span class="p">]),</span> <span class="n">loc</span><span class="p">)</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.dist_to"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.dist_to">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">dist_to</span><span class="p">(</span><span class="n">targets_array</span><span class="p">,</span> <span class="n">loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns an array of distances to the specified list of points from a given point</span>

<span class="sd">        :param targets_array: The array of xzy target coordinates</span>
<span class="sd">        :param loc: The target coordinate</span>
<span class="sd">        :return: An array of distances</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">targets_array</span> <span class="o">-</span> <span class="n">loc</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.get_locs_within_slice"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.get_locs_within_slice">[docs]</a>    <span class="k">def</span> <span class="nf">get_locs_within_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">particle_obj_name</span><span class="p">,</span> <span class="n">slice_obj_name</span><span class="p">,</span> <span class="n">allowed_particles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets a list of particle locations that are contained by a slice object</span>

<span class="sd">        :param particle_obj_name: A blender particle object</span>
<span class="sd">        :param slice_obj_name: A blender mesh object that represents the virtual slice</span>
<span class="sd">        :param allowed_particles: A list of particle ids that are allowed to be included. If None, not restricted.</span>
<span class="sd">        :param limit: A list of dicts with ids and locs of matching points</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">particles_obj</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="n">particle_obj_name</span><span class="p">]</span>
        <span class="n">particles</span> <span class="o">=</span> <span class="n">particles_obj</span><span class="o">.</span><span class="n">particle_systems</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">particles</span>
        <span class="n">particles_wm</span> <span class="o">=</span> <span class="n">particles_obj</span><span class="o">.</span><span class="n">matrix_world</span>
        <span class="n">slice_obj</span> <span class="o">=</span> <span class="n">bpy</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">objects</span><span class="p">[</span><span class="n">slice_obj_name</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[{</span> <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="s1">&#39;loc&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">particles_wm</span> <span class="o">*</span> <span class="n">ptc</span><span class="o">.</span><span class="n">location</span><span class="p">)}</span>
                           <span class="k">for</span> <span class="n">pid</span><span class="p">,</span> <span class="n">ptc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">particles</span><span class="p">)</span>
                           <span class="k">if</span> <span class="p">(</span><span class="n">allowed_particles</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">allowed_particles</span><span class="p">)</span> <span class="ow">and</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">is_inside</span><span class="p">(</span><span class="n">particles_wm</span> <span class="o">*</span> <span class="n">ptc</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="n">slice_obj</span><span class="p">)]</span>

        <span class="k">if</span> <span class="n">limit</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Selecting </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> locations inside slice&#39;</span><span class="o">%</span><span class="p">(</span><span class="n">limit</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">result</span><span class="p">),</span> <span class="n">particle_obj_name</span><span class="p">))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[:</span><span class="n">limit</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.is_inside"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.is_inside">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">is_inside</span><span class="p">(</span><span class="n">target_pt_global</span><span class="p">,</span> <span class="n">mesh_obj</span><span class="p">,</span> <span class="n">tolerance</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determines if a target point is inside a mesh</span>

<span class="sd">        :param target_pt_global: Target xyz point, in global coordinates</span>
<span class="sd">        :param mesh_obj: Target mesh object</span>
<span class="sd">        :param tolerance: A tolerance in degrees to account for rounding error in detecting points inside. &lt;=1 is generally sufficient.</span>
<span class="sd">        :return: True or False</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Convert the point from global space to mesh local space</span>
        <span class="n">target_pt_local</span> <span class="o">=</span> <span class="n">mesh_obj</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span> <span class="o">*</span> <span class="n">target_pt_global</span>

        <span class="c1"># Find the nearest point on the mesh and the nearest face normal</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">pt_closest</span><span class="p">,</span> <span class="n">face_normal</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">mesh_obj</span><span class="o">.</span><span class="n">closest_point_on_mesh</span><span class="p">(</span><span class="n">target_pt_local</span><span class="p">)</span>

        <span class="c1"># Get the target-closest pt vector</span>
        <span class="n">target_closest_pt_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">pt_closest</span> <span class="o">-</span> <span class="n">target_pt_local</span><span class="p">)</span><span class="o">.</span><span class="n">normalized</span><span class="p">()</span>

        <span class="c1"># Compute the dot product = |a||b|*cos(angle)</span>
        <span class="n">dot_prod</span> <span class="o">=</span> <span class="n">target_closest_pt_vec</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">face_normal</span><span class="p">)</span>

        <span class="c1"># Get the angle between the normal and the target-closest-pt vector (from the dot prod)</span>
        <span class="n">angle</span> <span class="o">=</span> <span class="n">acos</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">dot_prod</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">180</span> <span class="o">/</span> <span class="n">pi</span>

        <span class="c1"># Allow for some rounding error</span>
        <span class="n">inside</span> <span class="o">=</span> <span class="n">angle</span> <span class="o">&lt;</span> <span class="mi">90</span> <span class="o">-</span> <span class="n">tolerance</span>

        <span class="k">return</span> <span class="n">inside</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.unparent"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.unparent">[docs]</a>    <span class="k">def</span> <span class="nf">unparent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Removes the parent of a Blender object, and keeps the object in the same location</span>

<span class="sd">        :param obj: The blender object to unparent</span>
<span class="sd">        :return: The parent of the target object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">prev_parent</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">parent</span>
        <span class="n">parented_wm</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">=</span> <span class="n">parented_wm</span>
        <span class="k">return</span> <span class="n">prev_parent</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.parent"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.parent">[docs]</a>    <span class="k">def</span> <span class="nf">parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Make one blender object a parent of another</span>

<span class="sd">        :param obj: The child object</span>
<span class="sd">        :param parent: The child&#39;s parent object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">obj</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">matrix_parent_inverse</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.position_orient_align_mctc"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.position_orient_align_mctc">[docs]</a>    <span class="k">def</span> <span class="nf">position_orient_align_mctc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soma</span><span class="p">,</span> <span class="n">apic_start</span><span class="p">,</span> <span class="n">apic_end</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">closest_glom_loc</span><span class="p">,</span> <span class="n">apic_glom_loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: this appears to have the same/similar function as self.position_orient_cell. This may be</span>
<span class="sd">        redundant code.</span>

<span class="sd">        :param soma:</span>
<span class="sd">        :param apic_start:</span>
<span class="sd">        :param apic_end:</span>
<span class="sd">        :param loc:</span>
<span class="sd">        :param closest_glom_loc:</span>
<span class="sd">        :param apic_glom_loc:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Position and &#39;point&#39; cell towards closest glom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">position_orient_cell</span><span class="p">(</span><span class="n">soma</span><span class="p">,</span> <span class="n">apic_end</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">closest_glom_loc</span><span class="p">)</span>

        <span class="c1"># Temporarily unparent the apic start (location becomes global)</span>
        <span class="n">apic_start_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unparent</span><span class="p">(</span><span class="n">apic_start</span><span class="p">)</span>
        <span class="n">apic_end_parent</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">unparent</span><span class="p">(</span><span class="n">apic_end</span><span class="p">)</span>

        <span class="c1"># Compute the start and end alignment vectors (start apic-&gt;end apic TO start apic-&gt;glom)</span>
        <span class="c1"># Relative to apic_start</span>
        <span class="n">apic_start_wmi</span> <span class="o">=</span> <span class="n">apic_start</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span>
        <span class="n">apic_end_loc</span> <span class="o">=</span> <span class="n">apic_start_wmi</span> <span class="o">*</span> <span class="n">apic_end</span><span class="o">.</span><span class="n">location</span>

        <span class="n">startVec</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">apic_end_loc</span><span class="p">)</span>
        <span class="n">endVec</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">apic_start_wmi</span> <span class="o">*</span> <span class="n">Vector</span><span class="p">(</span><span class="n">apic_glom_loc</span><span class="p">))</span>

        <span class="c1"># Reparent the apic end (so it rotates with the start apic)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">apic_end</span><span class="p">,</span> <span class="n">apic_end_parent</span><span class="p">)</span>

        <span class="c1"># Compute rotation quaternion and rotate the start apic by it</span>
        <span class="n">initMW</span> <span class="o">=</span> <span class="n">apic_start</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rotM</span> <span class="o">=</span> <span class="n">startVec</span><span class="o">.</span><span class="n">rotation_difference</span><span class="p">(</span><span class="n">endVec</span><span class="p">)</span><span class="o">.</span><span class="n">to_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">to_4x4</span><span class="p">()</span>
        <span class="n">apic_start</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">=</span> <span class="n">initMW</span> <span class="o">*</span> <span class="n">rotM</span>

        <span class="c1"># Reparent the apic end (so it rotates with the start apic)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">(</span><span class="n">apic_start</span><span class="p">,</span> <span class="n">apic_start_parent</span><span class="p">)</span>

        <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.position_orient_cell"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.position_orient_cell">[docs]</a>    <span class="k">def</span> <span class="nf">position_orient_cell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">soma</span><span class="p">,</span> <span class="n">apic_end</span><span class="p">,</span> <span class="n">soma_loc</span><span class="p">,</span> <span class="n">closest_glom_loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Position cell at a location, rotate it around its apical dendrite axis,</span>
<span class="sd">        and rotate it around the soma so it&#39;s apical dendrite &#39;points&#39; towards</span>
<span class="sd">        the closest glomerulus location.</span>

<span class="sd">        :param soma: Blender object that holds the soma section</span>
<span class="sd">        :param apic_end: Blender object that holds the apical dendrite (furthest apical section on/near apical axis)</span>
<span class="sd">        :param soma_loc: The desired cell soma location</span>
<span class="sd">        :param closest_glom_loc: The location of the closest glomerulus</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Add random rotation around the apical axis</span>
        <span class="n">soma</span><span class="o">.</span><span class="n">rotation_euler</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="mi">360</span><span class="p">)</span> <span class="o">/</span> <span class="mf">180.0</span> <span class="o">*</span> <span class="n">pi</span>

        <span class="c1"># Position the soma</span>
        <span class="n">soma</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">soma_loc</span>

        <span class="c1"># Update child matrices</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

        <span class="c1"># Align the soma to be orthogonal to the soma-closest glom vector</span>
        <span class="n">soma_wmi</span> <span class="o">=</span> <span class="n">soma</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span>
        <span class="n">apic_end_loc</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">soma_wmi</span> <span class="o">*</span> <span class="n">apic_end</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">*</span> <span class="n">apic_end</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
        <span class="n">glom_loc</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">soma_wmi</span> <span class="o">*</span> <span class="n">Vector</span><span class="p">(</span><span class="n">closest_glom_loc</span><span class="p">))</span>

        <span class="n">initMW</span> <span class="o">=</span> <span class="n">soma</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rotM</span> <span class="o">=</span> <span class="n">apic_end_loc</span><span class="o">.</span><span class="n">rotation_difference</span><span class="p">(</span><span class="n">glom_loc</span><span class="p">)</span><span class="o">.</span><span class="n">to_matrix</span><span class="p">()</span><span class="o">.</span><span class="n">to_4x4</span><span class="p">()</span>
        <span class="n">soma</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">=</span> <span class="n">initMW</span> <span class="o">*</span> <span class="n">rotM</span>

        <span class="c1"># Update child matrices</span>
        <span class="n">bpy</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">scene</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>

<div class="viewcode-block" id="SliceBuilderBlender.extend_apic"><a class="viewcode-back" href="../../../olfactorybulb.slicebuilder.html#olfactorybulb.slicebuilder.blender.SliceBuilderBlender.extend_apic">[docs]</a>    <span class="k">def</span> <span class="nf">extend_apic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">apic_start</span><span class="p">,</span> <span class="n">apic_end</span><span class="p">,</span> <span class="n">apic_glom_loc</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: This is probably unused, leftover from an earlier version.</span>

<span class="sd">        :param apic_start:</span>
<span class="sd">        :param apic_end:</span>
<span class="sd">        :param apic_glom_loc:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Relative to apic_start</span>
        <span class="n">glom_loc</span> <span class="o">=</span> <span class="n">apic_start</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span> <span class="o">*</span> <span class="n">Vector</span><span class="p">(</span><span class="n">apic_glom_loc</span><span class="p">)</span>
        <span class="n">apic_end_loc</span> <span class="o">=</span> <span class="n">apic_start</span><span class="o">.</span><span class="n">matrix_world</span><span class="o">.</span><span class="n">inverted</span><span class="p">()</span> <span class="o">*</span> <span class="n">apic_end</span><span class="o">.</span><span class="n">matrix_world</span> <span class="o">*</span> <span class="n">apic_end</span><span class="o">.</span><span class="n">location</span>

        <span class="n">apic_glom_diff</span> <span class="o">=</span> <span class="n">Vector</span><span class="p">(</span><span class="n">glom_loc</span> <span class="o">-</span> <span class="n">apic_end_loc</span><span class="p">)</span>

        <span class="n">apic_start</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">apic_start</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">+</span> <span class="n">apic_glom_diff</span></div></div>



<span class="c1"># This makes it so the slice builder automatically runs when Blender loads</span>
<span class="n">bpy</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">scene_update_post</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">auto_start</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, Justas Birgiolas

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>